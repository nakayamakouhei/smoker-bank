<!-- app/views/cigarettes/select.html.erb -->
<div class="flex flex-col items-center flex-1 px-4 py-8">
  <div class="w-full max-w-md overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-xl">
    <div class="bg-gradient-to-r from-green-500 to-emerald-500 px-6 py-6 text-left">
      <p class="text-xs font-semibold uppercase tracking-widest text-white/70">Select Brand</p>
      <h1 class="mt-2 text-2xl font-bold text-white">お気に入りの銘柄を選択</h1>
      <p class="mt-1 text-xs text-white/80">リストから選ぶか、オリジナル銘柄を作成して記録できます。</p>
    </div>

    <div class="space-y-6 px-6 py-6">
      <% option_items = @cigarettes.map do |c|
           [c.name, c.id, { 'data-price': c.price }]
         end %>
      <% selected_cigarette = @cigarettes.find { |c| c.id == current_user.current_cigarette_id } %>
      <%= form_with url: update_selection_cigarettes_path, method: :patch, local: true, class: "space-y-4" do |f| %>
        <div class="space-y-2">
          <label for="current_cigarette_select" class="block text-sm font-semibold text-slate-800">既存の銘柄</label>
          <%= select_tag :current_cigarette_id,
                options_for_select(option_items, current_user.current_cigarette_id),
                include_blank: "選択してください",
                id: "current_cigarette_select",
                class: "w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500" %>
          <p class="text-xs text-slate-500">価格: <span id="cigarette-price"><%= selected_cigarette ? number_to_currency(selected_cigarette.price, unit: '', precision: 0) + '円' : '―' %></span></p>
        </div>

        <%= f.submit "この銘柄に変更する",
              class: "w-full rounded-lg bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-emerald-400 cursor-pointer" %>
      <% end %>

      <div class="rounded-xl border border-dashed border-emerald-200 bg-emerald-50/70 px-4 py-4 text-left">
        <p class="text-sm font-semibold text-slate-800">オリジナル銘柄を登録したい場合はこちら</p>
        <p class="mt-1 text-xs text-emerald-700">特殊な銘柄や独自の価格設定はこちらで管理できます。</p>
        <%= link_to "オリジナル銘柄を作成・選択",
              custom_cigarettes_path,
              class: "mt-4 inline-flex items-center justify-center gap-2 rounded-lg bg-white px-4 py-2 text-xs font-semibold text-emerald-600 shadow transition hover:bg-emerald-100" %>
      </div>
    </div>
  </div>

  <% if selected_any_cigarette? %>
    <div class="mt-6 w-full max-w-md">
      <%= link_to "ホームに戻る", authenticated_root_path,
            class: "block w-full rounded-lg bg-white px-4 py-2 text-center text-sm font-semibold text-emerald-600 shadow-lg transition hover:-translate-y-0.5 hover:bg-emerald-50" %>
    </div>
  <% end %>
</div>

<%= javascript_tag do %>
  document.addEventListener("turbo:load", function() {
    var select = document.getElementById("current_cigarette_select");
    if (!select) return;
    var priceEl = document.getElementById("cigarette-price");
    if (!priceEl) return;

    var formatPrice = function(value) {
      if (!value) return "―";
      var number = Number(value);
      if (isNaN(number)) return "―";
      return number.toLocaleString() + "円";
    };

    var updatePrice = function() {
      var option = select.options[select.selectedIndex];
      priceEl.textContent = option && option.dataset.price ? formatPrice(option.dataset.price) : "―";
    };

    updatePrice();
    select.addEventListener("change", updatePrice);
  });
<% end %>
