<!-- app/views/histories/index.html.erb -->
<div class="mx-auto w-full max-w-5xl px-4 py-6 sm:py-10">
  <!-- タイトル & サマリー -->
  <div class="mb-6 flex flex-col gap-6 md:mb-8 md:flex-row md:items-center md:justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-800 sm:text-3xl">履歴</h1>
      <p class="mt-1 text-xs text-gray-500 sm:text-sm">購入記録を振り返り、期間や条件で絞り込みできます。</p>
    </div>
    <%= render "histories/totals" %>
  </div>

  <!-- 戻るボタン -->
  <div class="mb-6">
    <%= link_to authenticated_root_path,
          class: "inline-flex w-full items-center justify-center gap-2 rounded-lg bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow transition hover:bg-gray-100 sm:w-auto" do %>
      <span class="text-lg">←</span> ホームに戻る
    <% end %>
  </div>

  <!-- 絞り込みフォーム -->
  <div class="mb-4 rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
    <%= form_with url: histories_path, method: :get, data: { turbo_frame: "histories_list" }, class: "flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between" do %>
      <div class="flex flex-col gap-2 lg:flex-row lg:items-center">
        <label for="sort" class="text-sm font-semibold text-gray-700">並び替え</label>
        <%= select_tag :sort,
              options_for_select([
                ['購入日（新しい順）', 'date_desc'],
                ['購入日（古い順）', 'date_asc'],
                ['銘柄名（A→Z）', 'name_asc'],
                ['価格（高い順）', 'price_desc'],
                ['価格（安い順）', 'price_asc']
              ], params[:sort]),
              class: "w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-green-500 focus:outline-none focus:ring-1 focus:ring-green-500 lg:w-48",
              onchange: "this.form.requestSubmit()" %>
      </div>

      <div class="flex flex-col gap-2 lg:flex-row lg:items-center">
        <span class="text-sm font-semibold text-gray-700">期間</span>
        <div class="flex gap-2">
          <%= date_field_tag :start_date, params[:start_date], class: "w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-green-500 focus:outline-none focus:ring-1 focus:ring-green-500" %>
          <span class="self-center text-gray-400">〜</span>
          <%= date_field_tag :end_date, params[:end_date], class: "w-full rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-green-500 focus:outline-none focus:ring-1 focus:ring-green-500" %>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <%= submit_tag '適用', class: "rounded-lg bg-green-500 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-green-400 cursor-pointer" %>
        <%= link_to 'クリア', histories_path, class: "rounded-lg bg-gray-200 px-4 py-2 text-sm font-semibold text-gray-700 shadow transition hover:bg-gray-300 cursor-pointer" %>
      </div>
    <% end %>
  </div>

  <!-- クイックレンジ -->
  <div class="mb-6 grid grid-cols-2 gap-3 sm:flex sm:flex-wrap">
    <% ranges = {
      "本日" => [Date.current, Date.current],
      "1週間" => [1.week.ago.to_date, Date.current],
      "今月" => [Date.current.beginning_of_month, Date.current.end_of_month],
      "先月" => [Date.current.last_month.beginning_of_month, Date.current.last_month.end_of_month]
    } %>
    <% ranges.each do |label, (start_date, end_date)| %>
      <%= link_to label,
          histories_path(start_date: start_date, end_date: end_date),
          class: "inline-flex items-center justify-center rounded-full border border-gray-300 bg-white px-4 py-2 text-sm text-gray-700 shadow-sm transition hover:border-green-400 hover:text-green-600" %>
    <% end %>
  </div>

  <!-- 履歴リスト -->
  <turbo-frame id="histories_list">
    <%= render "histories/list", histories: @histories, total_amount: @total_amount, total_packs: @total_packs %>
  </turbo-frame>
</div>
